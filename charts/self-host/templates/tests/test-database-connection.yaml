{{- if .Values.database.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "bitwarden.fullname" . }}-test-database-connection"
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "bitwarden.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "3"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: sqlcmd-test
    image: mcr.microsoft.com/mssql-tools:latest
    envFrom:
      - secretRef:
          name: {{ .Release.Name }}-sql-connection-string
    env:
      - name: SQLCMDUSER
        value: "sa"
      - name: SQLCMDPASSWORD
        valueFrom:
          secretKeyRef:
            name: {{ .Values.secrets.secretName | quote }}
            key: SA_PASSWORD
    command: ['/bin/bash']
    args: 
      - '-c'
      - |
        # Wait for SQL Server to be ready
        for i in {1..30}; do
          if /opt/mssql-tools/bin/sqlcmd -S {{ template "bitwarden.mssql" . }},1433 -Q "SELECT 1" > /dev/null 2>&1; then
            echo "Database connection successful"
            exit 0
          fi
          echo "Waiting for database... (attempt $i/30)"
          sleep 10
        done
        echo "Database connection failed"
        exit 1
  activeDeadlineSeconds: 600
{{- end }} 