suite: User provided secrets
templates:
  - templates/helpers.tpl
  - templates/pre-install-secret-keys.yaml
  - templates/api.yaml
  - templates/identity.yaml
  - templates/sso.yaml
tests:
  - it: should return auto-generated secret name when secretKeys.generate is true
    template: templates/api.yaml
    set:
      secrets.secretKeys.generate: true
    asserts:
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: RELEASE-NAME-self-host-secretkeys
        documentSelector:
          path: kind
          value: Deployment

  - it: should return user-provided secret name when secretKeys.generate is false
    template: templates/api.yaml
    set:
      secrets.secretKeys.generate: false
      secrets.secretName: "user-secret"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].envFrom
          content:
            secretRef:
              name: "user-secret"
        documentSelector:
          path: kind
          value: Deployment

  - it: should return auto-generated cert secret name when identityCertificate.generate is true
    template: templates/identity.yaml
    set:
      secrets.identityCertificate.generate: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: identity
            secret:
              secretName: RELEASE-NAME-identity-cert
        documentSelector:
          path: kind
          value: Deployment

  - it: should return user-provided cert secret name when identityCertificate.generate is false
    template: templates/identity.yaml
    set:
      secrets.secretName: "user-config"
      secrets.identityCertificate.generate: false
      secrets.identityCertificate.secretName: "user-cert"
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: identity
            secret:
              secretName: user-cert
              items:
                - key: identity.pfx
                  path: identity.pfx
        documentSelector:
          path: kind
          value: Deployment

  - it: should create pre-install secret when secretKeys.generate is true
    template: templates/pre-install-secret-keys.yaml
    set:
      secrets.secretKeys.generate: true
    asserts:
      - isKind:
          of: Secret
      - equal:
          path: metadata.name
          value: RELEASE-NAME-self-host-secretkeys

  - it: should not create pre-install secret when secretKeys.generate is false
    template: templates/pre-install-secret-keys.yaml
    set:
      secrets.secretKeys.generate: false
    asserts:
      - hasDocuments:
          count: 0

  - it: should have required encryption key fields in auto-generated secret
    template: templates/pre-install-secret-keys.yaml
    set:
      secrets.secretKeys.generate: true
    asserts:
      - isNotEmpty:
          path: data.globalSettings__internalIdentityKey
      - isNotEmpty:
          path: data.globalSettings__oidcIdentityClientKey
      - isNotEmpty:
          path: data.globalSettings__duo__aKey

  # Test: Password loaded from user-provided cert secret when generate is false
  - it: should load password from cert secret when generate is false
    template: templates/identity.yaml
    set:
      secrets.secretName: "user-config"
      secrets.secretKeys.generate: false
      secrets.identityCertificate.generate: false
      secrets.identityCertificate.secretName: "user-cert"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: globalSettings__identityServer__certificatePassword
            valueFrom:
              secretKeyRef:
                name: user-cert
                key: globalSettings__identityServer__certificatePassword
        documentSelector:
          path: kind
          value: Deployment

  # Test: Volume items field is set when generate is false
  - it: should use items field to mount only certificate when generate is false
    template: templates/identity.yaml
    set:
      secrets.secretName: "user-config"
      secrets.identityCertificate.generate: false
      secrets.identityCertificate.secretName: "user-cert"
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: identity
            secret:
              secretName: user-cert
              items:
                - key: identity.pfx
                  path: identity.pfx
        documentSelector:
          path: kind
          value: Deployment

  # Test: Volume items field is NOT set when generate is true
  - it: should not use items field when generate is true
    template: templates/identity.yaml
    set:
      secrets.identityCertificate.generate: true
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: identity
            secret:
              secretName: RELEASE-NAME-identity-cert
        documentSelector:
          path: kind
          value: Deployment
      - notContains:
          path: spec.template.spec.volumes
          content:
            name: identity
            secret:
              secretName: RELEASE-NAME-identity-cert
              items:
        documentSelector:
          path: kind
          value: Deployment

  # Test: Same tests for SSO deployment
  - it: should load password from cert secret in SSO when generate is false
    template: templates/sso.yaml
    set:
      secrets.secretName: "user-config"
      secrets.identityCertificate.generate: false
      secrets.identityCertificate.secretName: "user-cert"
    asserts:
      - contains:
          path: spec.template.spec.containers[0].env
          content:
            name: globalSettings__identityServer__certificatePassword
            valueFrom:
              secretKeyRef:
                name: user-cert
                key: globalSettings__identityServer__certificatePassword
        documentSelector:
          path: kind
          value: Deployment

  - it: should use items field in SSO when generate is false
    template: templates/sso.yaml
    set:
      secrets.secretName: "user-config"
      secrets.identityCertificate.generate: false
      secrets.identityCertificate.secretName: "user-cert"
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: identity
            secret:
              secretName: user-cert
              items:
                - key: identity.pfx
                  path: identity.pfx
        documentSelector:
          path: kind
          value: Deployment
