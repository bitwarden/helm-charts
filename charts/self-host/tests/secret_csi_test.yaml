suite: test secrets.secretProviderClass CSI volume configuration
templates:
  - templates/helpers.tpl
  - templates/api.yaml
tests:
  - it: should not create CSI volumes in api deployment when secretProviderClass is empty
    template: templates/api.yaml
    set:
      secrets.secretProviderClass: ""
    asserts:
      - notContains:
          path: spec.template.spec.volumes
          content:
            name: secrets-store-inline
        documentSelector:
          path: kind
          value: Deployment

  - it: should create CSI volumes in api deployment when secretProviderClass is set
    template: templates/api.yaml
    set:
      secrets.secretProviderClass: "my-provider-class"
    asserts:
      - contains:
          path: spec.template.spec.volumes
          content:
            name: secrets-store-inline
            csi:
              driver: secrets-store.csi.k8s.io
              readOnly: true
              volumeAttributes:
                secretProviderClass: my-provider-class
        documentSelector:
          path: kind
          value: Deployment

      - contains:
          path: spec.template.spec.containers[0].volumeMounts
          content:
            name: secrets-store-inline
            mountPath: "/mnt/secrets-store"
            readOnly: true
        documentSelector:
          path: kind
          value: Deployment
